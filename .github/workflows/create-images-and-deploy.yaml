name: Create docker images and deploy
run-name: Create docker images and deploy
on: push
env:
  IP: ${{ vars.HUTTUSTUTKA_IP }}
  KAYTTAJA: ${{ vars.HUTTUSTUTKA_KAYTTAJA }}
  REPON_SIJAINTI: ${{ vars.HUTTUSTUTKA_KANSIO }}
  HT_HOST: ${{ vars.HUTTUSTUTKA_HOST }}
jobs:
  create-images-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - run: mkdir ~/.ssh
      - run: echo "${{ secrets.HUTTUSTUTKA_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
      - run: sudo chmod 600 ~/.ssh/id_ed25519
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "rm -rf $REPON_SIJAINTI"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "git clone https://github.com/Huttusta/huttustutka"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "cd $REPON_SIJAINTI"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "./rakenna.sh -b huttustutka-back -f huttustutka-front"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "./aja.sh -b huttustutka-back -f huttustutka-front"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "docker image prune -a -f"
