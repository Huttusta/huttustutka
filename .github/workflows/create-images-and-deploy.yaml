name: Create docker images and deploy
run-name: Create docker images and deploy
on: push
env:
  IP: ${{ vars.HUTTUSTUTKA_IP }}
  KAYTTAJA: ${{ vars.HUTTUSTUTKA_KAYTTAJA }}
  REPON_SIJAINTI: ${{ vars.HUTTUSTUTKA_KANSIO }}
  HT_HOST: ${{ vars.HUTTUSTUTKA_HOST }}
  API_URL: ${{ vars.HUTTUSTUTKA_API_URL }}
jobs:
  create-images-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - run: mkdir ~/.ssh
      - run: echo "${{ secrets.HUTTUSTUTKA_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
      - run: sudo chmod 600 ~/.ssh/id_ed25519
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "rm -rf $REPON_SIJAINTI"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "git clone https://github.com/Huttusta/huttustutka $REPON_SIJAINTI"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "cd $REPON_SIJAINTI/front/; echo \"VITE_GOOGLE_API_KEY=${{ secrets.GMAPS_API_KEY }}\" >> .env.production; echo \"VITE_API_URL=$API_URL\" >> .env.production"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "cd $REPON_SIJAINTI; ./rakenna.sh -b huttustutka-back -f huttustutka-front"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "cd $REPON_SIJAINTI; ./aja.sh -b huttustutka-back -f huttustutka-front"
      - run: ssh $KAYTTAJA@$IP -o StrictHostKeyChecking=no "docker image prune -a -f"
